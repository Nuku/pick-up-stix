{"version":3,"sources":["module/pick-up-stix/hooks.ts"],"names":[],"mappings":"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","file":"../../../src/module/pick-up-stix/hooks.js","sourcesContent":["/* ------------------------------------ */\r\n/* When ready\t\t\t\t\t\t\t\t\t\t\t\t\t  */\r\nimport {\r\n\tsetupMouseManager,\r\n\thandleDropItem,\r\n\tdrawLockIcon,\r\n\tlootTokens\r\n} from \"./main\";\r\nimport { registerSettings } from \"./settings\";\r\nimport { preloadTemplates } from \"./preloadTemplates\";\r\nimport { PickUpStixSocketMessage, SocketMessageType, PickUpStixFlags, ItemType } from \"./models\";\r\nimport { handleOnDrop } from \"./overrides\";\r\n\r\n/**\r\n * TODO: This should be removed once 0.7.0 becomes stable\r\n */\r\ndeclare class DragDrop {\r\n\tconstructor(options: DragDropOptions);\r\n\r\n\tbind(canvas: any);\r\n}\r\n\r\n/**\r\n * TODO: This should be removed once 0.7.0 becomes stable\r\n */\r\ndeclare interface DragDropOptions {\r\n\tdragSelector?;\r\n\tdropSelector?;\r\n\tpermissions?;\r\n\tcallbacks?;\r\n}\r\n\r\n/* ------------------------------------ */\r\n/* Initialize module\t\t\t\t\t*/\r\n/* ------------------------------------ */\r\nexport async function initHook() {\r\n\tconsole.log('pick-up-stix | initHook');\r\n\r\n\t//CONFIG.debug.hooks = true;\r\n\r\n\t// Assign custom classes and constants here\r\n\r\n\t// Register custom module settings\r\n\tregisterSettings();\r\n\r\n\t// Preload Handlebars templates\r\n\tawait preloadTemplates();\r\n\r\n\tHandlebars.registerHelper('capitalize', (input: string) => {\r\n\t\treturn `${input[0].toUpperCase()} ${input.slice(1)}`;\r\n\t});\r\n\r\n\t// Register custom sheets (if any)\r\n};\r\n\r\n/* ------------------------------------ */\r\nexport function readyHook() {\r\n\t// Do anything once the module is ready\r\n\tconsole.log(`pick-up-stix | readyHook`);\r\n\r\n\tsocket = game.socket;\r\n\r\n\tsocket.on('module.pick-up-stix', async (msg: PickUpStixSocketMessage) => {\r\n\t\tconsole.log(`pick-up-stix | socket.on | received socket message with args:`);\r\n\t\tconsole.log(msg);\r\n\r\n\t\tif (msg.sender === game.user.id) {\r\n\t\t\tconsole.log(`pick-up-stix | socket.on | i sent this, ignoring`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst firstGm = game.users.find((u) => u.isGM && u.active);\r\n\t\tif (firstGm && game.user !== firstGm) {\r\n   \t\treturn;\r\n\t\t}\r\n\r\n\t\tlet actor;\r\n\t\tlet token;\r\n\r\n\t\tswitch (msg.type) {\r\n\t\t\tcase SocketMessageType.updateActor:\r\n\t\t\t\tactor = game.actors.get(msg.data.actorId);\r\n\t\t\t\tawait actor.update(msg.data.updates);\r\n\t\t\t\tbreak;\r\n\t\t\tcase SocketMessageType.deleteToken:\r\n\t\t\t\tawait canvas.scene.deleteEmbeddedEntity('Token', msg.data);\r\n\t\t\t\tbreak;\r\n\t\t\tcase SocketMessageType.updateToken:\r\n\t\t\t\ttoken = canvas.tokens.get(msg.data.tokenId);\r\n\t\t\t\tawait token.update(msg.data.updates);\r\n\t\t\t\tbreak;\r\n\t\t\tcase SocketMessageType.createOwnedEntity:\r\n\t\t\t\tactor = game.actors.get(msg.data.actorId);\r\n\t\t\t\tawait actor.createOwnedItem(msg.data.items);\r\n\t\t\t\tbreak;\r\n\t\t\tcase SocketMessageType.createItemToken:\r\n\t\t\t\tawait Token.create(msg.data);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t});\r\n};\r\n\r\nexport async function onCanvasReady(...args) {\r\n\tconsole.log(`pick-up-stix | onCanvasReady | call width args:`);\r\n\tconsole.log(args);\r\n\r\n  canvas?.tokens?.placeables?.forEach(async (p: PlaceableObject) => {\r\n\t\tconst flags: PickUpStixFlags = p.getFlag('pick-up-stix', 'pick-up-stix');\r\n\r\n\t\tif (flags) {\r\n\t\t\tconsole.log(`pick-up-stix | onCanvasReady | found token ${p.id} with itemData`);\r\n\t\t\tp.mouseInteractionManager = setupMouseManager.bind(p)();\r\n\r\n\t\t\tif (flags.isLocked) {\r\n\t\t\t\tawait drawLockIcon(p);\r\n\t\t\t}\r\n\t\t}\r\n  });\r\n\r\n\tconst coreVersion: string = game.data.version;\r\n\tif (isNewerVersion(coreVersion, '0.6.5')) {\r\n    console.log(`pick-up-stix | onCanvasReady | Foundry version newer than 0.6.5. Using dropCanvasData hook`);\r\n\r\n\t\tHooks.on('dropCanvasData', async (canvas, dropData) => {\r\n\t\t\tconsole.log(`pick-up-stix | dropCanvasData | called with args:`);\r\n\t\t\tconsole.log(canvas, dropData);\r\n\r\n\t\t\tif (dropData.type === \"Item\") {\r\n\t\t\t\thandleDropItem(dropData);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse {\r\n\t\tconsole.log(`pick-up-stix | onCanvasReady | Foundry version is 0.6.5 or below. Overriding Canvas._onDrop`);\r\n\r\n\t\tnew DragDrop({ callbacks: { drop: handleOnDrop.bind(canvas) } }).bind(document.getElementById('board'));\r\n\t}\r\n}\r\n\r\nexport async function onPreCreateOwnedItem(actor: Actor, itemData: any, options: any, userId: string) {\r\n\tconsole.log(`pick-up-stix | onPreCreateOwnedItem | called with args:`);\r\n\tconsole.log([actor, itemData, options, userId]);\r\n\r\n\tlet owner: { actorId: string, itemId: string };\r\n\tif (owner = getProperty(itemData.flags, 'pick-up-stix.pick-up-stix.owner')) {\r\n\t\t// if the item is already owned by someone else, set the new actor as the owner and\r\n\t\t// delete the item from the old owner\r\n\t\tsetProperty(itemData.flags, 'pick-up-stix.pick-up-stix.owner', { actorId: actor.id });\r\n\t\tconst ownerActor = game.actors.get(owner.actorId);\r\n\t\tawait ownerActor.deleteOwnedItem(itemData._id);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsetProperty(itemData.flags, 'pick-up-stix.pick-up-stix', {\r\n\t\towner: {\r\n\t\t\tactorId: actor.id\r\n\t\t},\r\n\t\tinitialState: { id: itemData._id, count: 1, itemData: { ...itemData, flags: {} } },\r\n\t\titemType: ItemType.ITEM,\r\n\t\tisLocked: false\r\n\t});\r\n};\r\n\r\nexport function onDeleteToken(scene: Scene, tokenData: any, data: any, userId: string) {\r\n\tconsole.log(`pick-up-stix | onDeleteToken | called with args:`);\r\n\tconsole.log([scene, tokenData, data, userId]);\r\n\tlootTokens.findSplice(t => t === tokenData._id);\r\n}\r\n\r\nexport async function onUpdateToken(scene: Scene, tokenData: any, tokenFlags: any, userId: string) {\r\n  console.log(`pick-up-stix | onUpdateToken | called with args:`)\r\n  console.log([scene, tokenData, tokenFlags, userId]);\r\n\r\n  const flags = getProperty(tokenData, 'flags.pick-up-stix.pick-up-stix');\r\n\r\n\tif (flags) {\r\n      console.log(`pick-up-stix | onUpdateToken | found flags on token data, add mouse interaction`);\r\n\t\t\tconst token: Token = canvas?.tokens?.placeables?.find((p: PlaceableObject) => p.id === tokenData._id);\r\n\r\n\t\t\tif (flags.isLocked) {\r\n\t\t\t\tawait drawLockIcon(token);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tconst lock = token.getChildByName('pick-up-stix-lock');\r\n\t\t\t\tif (lock) {\r\n\t\t\t\t\ttoken.removeChild(lock);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\ttoken.mouseInteractionManager = setupMouseManager.bind(token)();\r\n\t\t\ttoken.activateListeners = setupMouseManager.bind(token);\r\n\t}\r\n};\r\n\r\nexport async function onCreateToken(scene: Scene, tokenData: any, options: any, userId: string) {\r\n  console.log(`pick-up-stix | onCreateToken | called with args:`);\r\n  console.log([scene, tokenData, options, userId]);\r\n\r\n  const flags = getProperty(tokenData, 'flags.pick-up-stix.pick-up-stix');\r\n\r\n\tif (flags) {\r\n      console.log(`pick-up-stix | onCreateToken | found flags on token data, add mouse interaction`);\r\n      const token: Token = canvas?.tokens?.placeables?.find((p: PlaceableObject) => p.id === tokenData._id);\r\n\t\t\ttoken.mouseInteractionManager = setupMouseManager.bind(token)();\r\n\t\t\ttoken.activateListeners = setupMouseManager.bind(token);\r\n\t}\r\n};\r\n"]}