{"version":3,"sources":["module/pick-up-stix/item-config-application.ts"],"names":[],"mappings":"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","file":"../../../src/module/pick-up-stix/item-config-application.js","sourcesContent":["import ContainerImageSelectionApplication from \"../container-image-selection-application\";\r\nimport { createOwnedEntity } from './main';\r\n\r\n/**\r\n * Application class to display to select an item that the token is\r\n * associated with\r\n */\r\nexport default class ItemConfigApplication extends FormApplication {\r\n\tprivate _html: any;\r\n\tprivate _loot: {\r\n\t\t[key: string]: any[];\r\n\t} = {};\r\n\r\n\tstatic get defaultOptions(): ApplicationOptions {\r\n\t\treturn mergeObject(super.defaultOptions, {\r\n\t\t\tcloseOnSubmit: false,\r\n\t\t\tid: \"pick-up-stix-item-config\",\r\n\t\t\ttemplate: \"modules/pick-up-stix/module/pick-up-stix/templates/item-config.html\",\r\n\t\t\twidth: 500,\r\n\t\t\theight: 'auto',\r\n\t\t\tminimizable: false,\r\n\t\t\ttitle: `${game.user.isGM ? 'Configure Loot Container' : 'Loot Container'}`,\r\n\t\t\tresizable: true,\r\n\t\t\tclasses: ['dnd5e', 'sheet', 'actor', 'character'],\r\n\t\t\tdragDrop: [{ dropSelector: null }]\r\n\t\t});\r\n\t}\r\n\r\n\tconstructor(private _token: Token) {\r\n\t\tsuper({});\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | constructed with args:`)\r\n\t\tconsole.log(this._token);\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | activateListeners called with args:`);\r\n\t\tconsole.log(html);\r\n\r\n\t\tthis._html = html;\r\n\t\tsuper.activateListeners(this._html);\r\n\r\n\t\t$(html).find(`[data-edit=\"img\"]`).click(e => this._onEditImage(e));\r\n\t\t$(html).find(`a.item-take`).click(e => this._onTakeItem(e));\r\n\t}\r\n\r\n\tgetData() {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | getData`);\r\n\t\tconst data = {\r\n\t\t\tobject: this._token.data,\r\n\t\t\tcontainerDescription: getProperty(this._token.data, 'flags.pick-up-stix.pick-up-stix.initialState.itemData.data.description.value')?.replace(/font-size:\\s*\\d*.*;/, 'font-size: 18px;') ?? '',\r\n\t\t\tloot: Object.entries(this._loot).reduce((prev, [k, v]) => {\r\n\t\t\t\tprev[k] = v.reduce((prev, itemData) => {\r\n\t\t\t\t\tconst existing = prev.find(i => i._id === itemData._id);\r\n\t\t\t\t\tif (existing) {\r\n\t\t\t\t\t\texisting.qty = existing.qty + 1;\r\n\t\t\t\t\t\texisting.price = existing.qty * existing.data.price;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tprev.push({...itemData, qty: 1, price: itemData.data.price})\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn prev;\r\n\t\t\t\t}, []);\r\n\t\t\t\treturn prev;\r\n\t\t\t}, {})\r\n\t\t};\r\n\t\t// console.log(data);\r\n\t\treturn data;\r\n\t}\r\n\r\n\tprotected async _onTakeItem(e) {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | _onTakeItem`);\r\n\t\tconst itemId = e.currentTarget.dataset.id;\r\n\t\tconst actor = canvas.tokens.controlled[0].actor;\r\n\t\tconst itemType = $(e.currentTarget).parents(`ol[data-itemType]`).attr('data-itemType');\r\n\t\tconst itemData = this._loot?.[itemType]?.findSplice(i => i._id === itemId);\r\n\t\tconsole.log([itemId, actor, itemType, itemData]);\r\n\t\tawait createOwnedEntity(actor, [itemData]);\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tprotected _onEditImage(e) {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | _onEditImage`);\r\n\t\tconst f = new ContainerImageSelectionApplication(this._token).render(true);\r\n\r\n\t\tHooks.once('closeContainerImageSelectionApplication', () => {\r\n\t\t\tconsole.log(`pick-up-stix | ItemConfigApplication | closeContainerImageSelectionApplication hook`);\r\n\t\t\tthis.render();\r\n\t\t});\r\n\t}\r\n\r\n\tprotected async _onDrop(e) {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | _onDrop`)\r\n\t\tconst data = JSON.parse(e.dataTransfer.getData('text/plain'));\r\n\r\n\t\tif (data.type !== \"Item\") {\r\n\t\t\tconsole.log(`pick-up-stix | ItemConfigApplication | _onDrop | item is not 'Item' type`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst itemData = data.data ?? await game.items.get(data.id)?.data ?? await game.packs.get(data.pack).getEntry(data.id);\r\n\t\tconst itemType = itemData.type;\r\n\r\n\t\tif (!this._loot[itemType]) {\r\n\t\t\tthis._loot[itemType] = [];\r\n\t\t}\r\n\t\tthis._loot[itemType].push(itemData);\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tprotected _updateObject(e, formData) {\r\n\t\treturn Promise.resolve(true);\r\n\t}\r\n}\r\n"]}