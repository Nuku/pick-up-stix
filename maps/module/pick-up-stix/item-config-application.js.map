{"version":3,"sources":["module/pick-up-stix/item-config-application.ts"],"names":[],"mappings":"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","file":"../../../src/module/pick-up-stix/item-config-application.js","sourcesContent":["import ContainerImageSelectionApplication from \"../container-image-selection-application\";\r\nimport { createOwnedEntity } from './main';\r\nimport { ItemType } from \"./models\";\r\n\r\n/**\r\n * Application class to display to select an item that the token is\r\n * associated with\r\n */\r\nexport default class ItemConfigApplication extends FormApplication {\r\n\tprivate _html: any;\r\n\r\n\t/**\r\n\t * This is an object of the loot that this container holds. The keys are the loot type\r\n\t * `weapon`, `equipment`, `consumable`, `backpack`, `tool`, `loot`. The values will\r\n\t * be an array of Item instance data\r\n\t */\r\n\tprivate _loot: {\r\n\t\t[key: string]: any[];\r\n\t};\r\n\r\n\tstatic get defaultOptions(): ApplicationOptions {\r\n\t\treturn mergeObject(super.defaultOptions, {\r\n\t\t\tcloseOnSubmit: false,\r\n\t\t\tid: \"pick-up-stix-item-config\",\r\n\t\t\ttemplate: \"modules/pick-up-stix/module/pick-up-stix/templates/item-config.html\",\r\n\t\t\twidth: 500,\r\n\t\t\theight: 'auto',\r\n\t\t\tminimizable: false,\r\n\t\t\ttitle: `${game.user.isGM ? 'Configure Loot Container' : 'Loot Container'}`,\r\n\t\t\tresizable: true,\r\n\t\t\tclasses: ['dnd5e', 'sheet', 'actor', 'character'],\r\n\t\t\tdragDrop: [{ dropSelector: null }]\r\n\t\t});\r\n\t}\r\n\r\n\tconstructor(private _token: Token) {\r\n\t\tsuper({});\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | constructed with args:`)\r\n\t\tconsole.log(this._token);\r\n\t\tthis._loot = this._token.getFlag('pick-up-stix', 'pick-up-stix.containerLoot') ?? {};\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | activateListeners`);\r\n\t\tthis._html = html;\r\n\t\tsuper.activateListeners(this._html);\r\n\r\n\t\t// set the click listener on the image\r\n\t\t$(html).find(`[data-edit=\"img\"]`).click(e => this._onEditImage(e));\r\n\r\n\t\t// set click listeners on the buttons to pick up individual items\r\n\t\t$(html).find(`a.item-take`).click(e => this._onTakeItem(e));\r\n\t}\r\n\r\n\tgetData() {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | getData`);\r\n\t\tconst data = {\r\n\t\t\tobject: this._token.data,\r\n\t\t\tcontainerDescription: getProperty(this._token.data, 'flags.pick-up-stix.pick-up-stix.initialState.itemData.data.description.value')?.replace(/font-size:\\s*\\d*.*;/, 'font-size: 18px;') ?? '',\r\n\t\t\tloot: this._loot\r\n\t\t};\r\n\t\tconsole.log(data);\r\n\t\treturn data;\r\n\t}\r\n\r\n\tprotected async _onTakeItem(e) {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | _onTakeItem`);\r\n\t\tconst itemId = e.currentTarget.dataset.id;\r\n\t\tconst actor = canvas.tokens.controlled?.[0]?.actor;\r\n\t\tif (!actor) {\r\n\t\t\tui.notifications.error('You must be controlling only one token to pick up an item');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst itemType = $(e.currentTarget).parents(`ol[data-itemType]`).attr('data-itemType');\r\n\t\tconst itemData = this._loot?.[itemType]?.find(i => i._id === itemId);\r\n\t\tif (--itemData.qty === 0) {\r\n\t\t\tthis._loot?.[itemType].findSplice(i => i._id === itemId);\r\n\t\t}\r\n\t\tsetProperty(itemData, 'flags.pick-up-stix.pick-up-stix', {\r\n\t\t\tinitialState: { id: itemData._id, count: 1, itemData: { ...itemData, flags: {} } },\r\n\t\t\timageOriginalPath: itemData.img,\r\n\t\t\titemType: ItemType.ITEM,\r\n\t\t\tisLocked: false\r\n\t\t});\r\n\t\tconsole.log([itemId, actor, itemType, itemData]);\r\n\t\tawait createOwnedEntity(actor, [itemData]);\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tprotected _onEditImage(e) {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | _onEditImage`);\r\n\t\tconst f = new ContainerImageSelectionApplication(this._token).render(true);\r\n\r\n\t\tHooks.once('closeContainerImageSelectionApplication', () => {\r\n\t\t\tconsole.log(`pick-up-stix | ItemConfigApplication | closeContainerImageSelectionApplication hook`);\r\n\t\t\tthis.submit();\r\n\t\t});\r\n\t}\r\n\r\n\tprotected async _onDrop(e) {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | _onDrop`);\r\n\t\tconst data = JSON.parse(e.dataTransfer.getData('text/plain'));\r\n\t\tconsole.log(data);\r\n\r\n\t\tif (data.type !== \"Item\") {\r\n\t\t\tconsole.log(`pick-up-stix | ItemConfigApplication | _onDrop | item is not 'Item' type`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (data.actorId) {\r\n\t\t\tawait game.actors.get(data.actorId).deleteOwnedItem(data.data._id);\r\n\t\t}\r\n\r\n\t\tlet itemData = data.data ?? await game.items.get(data.id)?.data ?? await game.packs.get(data.pack).getEntry(data.id);\r\n\r\n\t\tif (data.actorId) {\r\n\t\t\titemData = { ...getProperty(itemData, 'flags.pick-up-stix.pick-up-stix.initialState.itemData') };\r\n\t\t}\r\n\r\n\t\tconst itemType = itemData.type;\r\n\r\n\t\tif (!this._loot[itemType]) {\r\n\t\t\tthis._loot[itemType] = [];\r\n\t\t}\r\n\t\tconst existingItem = this._loot[itemType].find(i => i._id === itemData._id);\r\n\t\tif (existingItem) {\r\n\t\t\texistingItem.qty++;\r\n\t\t}\r\n\t\telse {\r\n\t\t\titemData.qty = 1;\r\n\t\t\tthis._loot[itemType].push(itemData);\r\n\t\t}\r\n\t\tawait this.submit();\r\n\t}\r\n\r\n\tprotected async _updateObject(e, formData) {\r\n\t\tconsole.log(`pick-up-stix | ItemConfigApplication | _onUpdateObject called with args:`);\r\n\t\tformData.img = this._token.getFlag('pick-up-stix', 'pick-up-stix.isOpen') ? this._token.getFlag('pick-up-stix', 'pick-up-stix.imageContainerOpenPath') : this._token.getFlag('pick-up-stix', 'pick-up-stix.imageContainerClosedPath');\r\n\t\tsetProperty(formData, 'flags.pick-up-stix.pick-up-stix.containerLoot', { ...this._loot });\r\n\t\tdelete formData._id;\r\n\t\tconsole.log([e, formData]);\r\n\t\tawait this._token.update(formData);\r\n\t\tthis.render();\r\n\t}\r\n}\r\n"]}