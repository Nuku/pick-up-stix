{"version":3,"sources":["module/pick-up-stix/main.ts"],"names":[],"mappings":"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","file":"../../../src/module/pick-up-stix/main.js","sourcesContent":["import { PickUpStixFlags, PickUpStixSocketMessage, SocketMessageType, ItemType } from \"./models\";\r\nimport ItemConfigApplication from \"./item-config-application\";\r\nimport ChooseTokenApplication from \"./choose-token-application\";\r\nimport { dist } from '../../utils'\r\n\r\nexport const lootTokens: string[] = [];\r\n\r\n/**\r\n * Handles data dropped onto the canvas.\r\n * @param dropData\r\n */\r\nexport async function handleDropItem(dropData: { actorId?: string, pack?: string, id?: string, data?: any, x: number, y: number }) {\r\n\tconsole.log(`pick-up-stix | handleDropItem | called with args:`);\r\n\tconsole.log(dropData);\r\n\r\n\t// if the item came from an actor's inventory, then it'll have an actorId property, we'll need to remove the item from that actor\r\n\tconst sourceActorId: string = dropData.actorId;\r\n\r\n\tlet pack: string;\r\n\tlet itemId: string;\r\n\tlet itemData: any;\r\n\r\n\t// if the item comes from an actor's inventory, then the data structure is a tad different, the item data is stored\r\n\t// in a data property on the dropData parameter rather than on the top-level of the dropData\r\n\tif (sourceActorId) {\r\n\t\tconsole.log(`pick-up-stix | handleDropItem | actor '${sourceActorId}' dropped item, get item data from the dropped item's original item data`);\r\n\t\titemData = {\r\n\t\t\t...dropData.data.flags?.['pick-up-stix']?.['pick-up-stix']?.['initialState']?.['itemData'] ?? {}\r\n\t\t};\r\n\t\titemId = itemData._id;\r\n\r\n\t\tawait game.actors.get(sourceActorId).deleteOwnedItem(dropData.data._id);\r\n\t}\r\n\telse {\r\n\t\tconsole.log(`pick-up-stix | handleDropItem | item comes from directory or compendium, item data comes from directory or compendium`);\r\n\t\tpack = dropData.pack;\r\n\t\titemId = dropData.id;\r\n\t\tconst item: Item = await game.packs.get(pack)?.getEntity(itemId) ?? game.items.get(itemId);\r\n\t\tif (!item) {\r\n\t\t\tconsole.log(`pick-up-stix | handleDropItem | item '${dropData.id}' not found in game items or compendium`);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\titemData = {\r\n\t\t\t...item.data\r\n\t\t}\r\n\t}\r\n\r\n\tconsole.log(`pick-up-stix | handleDropItem | itemData:`);\r\n\tconsole.log(itemData);\r\n\r\n\tconst droppedItemIsContainer = getProperty(itemData, 'flags.pick-up-stix.pick-up-stix.itemType') === ItemType.CONTAINER;\r\n\r\n\tlet targetToken: Token;\r\n\tlet p: PlaceableObject;\r\n\tfor (p of canvas.tokens.placeables) {\r\n\t\tif (dropData.x < p.x + p.width && dropData.x > p.x && dropData.y < p.y + p.height && dropData.y > p.y && p instanceof Token) {\r\n\t\t\ttargetToken = p;\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\t// if the drop was ont another token, check what type of token it was dropped on\r\n\tif (targetToken) {\r\n\t\tif (droppedItemIsContainer) {\r\n\t\t\tui.notifications.error('Cannot drop container onto target');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconsole.log(`pick-up-stix | handleDropItem | item dropped onto target token '${targetToken.id}'`);\r\n\r\n\t\tconst targetTokenFlags: PickUpStixFlags = targetToken.getFlag('pick-up-stix', 'pick-up-stix');\r\n\r\n\t\tif (targetTokenFlags?.itemType === ItemType.CONTAINER) {\r\n\t\t\t// if the target is a container, then add the item to the container's data\r\n\t\t\tconsole.log(`pick-up-stix | handleDropItem | target token is a container`);\r\n\t\t\tconst existingLoot = { ...duplicate(targetTokenFlags.containerLoot) };\r\n\t\t\tconst existingItem: any = Object.values(existingLoot[itemData.type] ?? [])?.find(i => (i as any)._id === itemId);\r\n\t\t\tif (existingItem) {\r\n\t\t\t\tconsole.log(`pick-up-stix | handleDropItem | found existing item for item '${itemId}`);\r\n\t\t\t\tconsole.log(existingItem);\r\n\r\n\t\t\t\tif(!existingItem.qty) existingItem.qty = 1;\r\n\r\n\t\t\t\texistingItem.qty++;\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tconsole.log(`pick-up-stix | handleDropItem | Could not find existing item from '${itemId}`);\r\n\t\t\t\tif (!existingLoot[itemData.type]) {\r\n\t\t\t\t\texistingLoot[itemData.type] = [];\r\n\t\t\t\t}\r\n\t\t\t\t(existingLoot[itemData.type] as any).push({ ...itemData, qty: 1 });\r\n\t\t\t}\r\n\r\n\t\t\tconst update = {\r\n\t\t\t\tflags: {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t'containerLoot': {\r\n\t\t\t\t\t\t\t\t...existingLoot\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\t\t\tawait updateToken(targetToken, update);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\telse if (targetToken.actor) {\r\n\t\t\t// if the token it was dropped on was an actor, add the item to the new actor\r\n\t\t\tawait createOwnedEntity(targetToken.actor, [{\r\n\t\t\t\t...itemData,\r\n\t\t\t\tflags: {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\tinitialState: { id: itemData._id, count: 1, itemData: { ...itemData } },\r\n\t\t\t\t\t\t\titemType: ItemType.ITEM,\r\n\t\t\t\t\t\t\tisLocked: false\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}]);\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n\r\n\t// if it's not a container, then we can assume it's an item. Create the item token\r\n\tconst hg = canvas.dimensions.size / 2;\r\n\tdropData.x -= (hg);\r\n\tdropData.y -= (hg);\r\n\r\n\tconst { x, y } = canvas.grid.getSnappedPosition(dropData.x, dropData.y, 1);\r\n\tdropData.x = x;\r\n\tdropData.y = y;\r\n\r\n\tlet tokenId;\r\n\r\n\t// if the item being dropped is a container, just create the empty container\r\n\tif (droppedItemIsContainer) {\r\n\t\tconsole.log(`pick-up-stix | handleDropItem | dropped item is a container`);\r\n\t\ttokenId = await createItemToken({\r\n\t\t\timg: itemData.flags['pick-up-stix']['pick-up-stix']['imageContainerClosedPath'],\r\n\t\t\tname: itemData.name,\r\n\t\t\tx: dropData.x,\r\n\t\t\ty: dropData.y,\r\n\t\t\tdisposition: 0,\r\n\t\t\tflags: {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\tcanClose: true,\r\n\t\t\t\t\t\tisLocked: false,\r\n\t\t\t\t\t\tisOpen: false,\r\n\t\t\t\t\t\titemType: ItemType.CONTAINER,\r\n\t\t\t\t\t\t...itemData.flags['pick-up-stix']['pick-up-stix'],\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\treturn;\r\n\t}\r\n\r\n\tlet updates: any = {};\r\n\r\n\t// if a Token was successfully created\r\n\tif (!sourceActorId) {\r\n\t\tawait new Promise(resolve => {\r\n\t\t\t// get a reference to the Token\r\n\t\t\tconst token: Token = canvas.tokens.placeables.find(p => p.id === tokenId);\r\n\t\t\t// render the item type selection form\r\n\t\t\tnew Dialog({\r\n\t\t\t\tcontent: 'What kind of loot is this?',\r\n\t\t\t\tdefault: 'one',\r\n\t\t\t\ttitle: 'Loot Type',\r\n\t\t\t\tclose: (...args) => resolve(),\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tone: {\r\n\t\t\t\t\t\ticon: '<i class=\"fas fa-box\"></i>',\r\n\t\t\t\t\t\tlabel: 'Item',\r\n\t\t\t\t\t\tcallback: () => updates = {\r\n\t\t\t\t\t\t\timg: itemData.img,\r\n\t\t\t\t\t\t\tflags: {\r\n\t\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t\t\titemType: ItemType.ITEM,\r\n\t\t\t\t\t\t\t\t\t\tisLocked: false\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\ttwo: {\r\n\t\t\t\t\t\ticon: '<i class=\"fas fa-boxes\"></i>',\r\n\t\t\t\t\t\tlabel: 'Container',\r\n\t\t\t\t\t\tcallback: () => updates = {\r\n\t\t\t\t\t\t\timg: game.settings.get('pick-up-stix', 'default-container-closed-image-path'),\r\n\t\t\t\t\t\t\tflags: {\r\n\t\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t\t\timageContainerClosedPath: game.settings.get('pick-up-stix', 'default-container-closed-image-path'),\r\n\t\t\t\t\t\t\t\t\t\timageContainerOpenPath: game.settings.get('pick-up-stix', 'default-container-opened-image-path'),\r\n\t\t\t\t\t\t\t\t\t\titemType: ItemType.CONTAINER,\r\n\t\t\t\t\t\t\t\t\t\tisLocked: false\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}).render(true);\r\n\r\n\t\t\tlootTokens.push(tokenId);\r\n\t\t});\r\n\t}\r\n\telse {\r\n\t\tupdates = {\r\n\t\t\t...itemData,\r\n\t\t\tflags: {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\titemType: ItemType.ITEM,\r\n\t\t\t\t\t\tisLocked: false\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttokenId = await createItemToken({\r\n\t\t...updates,\r\n\t\tname: itemData.name,\r\n\t\tx: dropData.x,\r\n\t\ty: dropData.y,\r\n\t\tdisposition: 0,\r\n\t\tflags: {\r\n\t\t\t'pick-up-stix': {\r\n\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t...updates?.flags?.['pick-up-stix']?.['pick-up-stix'] ?? {},\r\n\t\t\t\t\tinitialState: { id: itemData._id, count: 1, itemData: { ...itemData } }\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nexport function setupMouseManager(): void {\r\n\tconsole.log(`pick-up-stix | setupMouseManager`);\r\n\r\n\tconst permissions = {\r\n\t\tclickLeft: () => true,\r\n\t\tclickLeft2: () => game.user.isGM,\r\n\t\tclickRight: () => game.user.isGM,\r\n\t\tdragStart: this._canDrag\r\n\t};\r\n\r\n\t// Define callback functions for each workflow step\r\n\tconst callbacks = {\r\n\t\tclickLeft: handleTokenItemClicked.bind(this),\r\n\t\tclickLeft2: handleTokenItemConfig.bind(this),\r\n\t\tclickRight: toggleItemLocked.bind(this),\r\n\t\tdragLeftStart: this._onDragLeftStart,\r\n\t\tdragLeftMove: this._onDragLeftMove,\r\n\t\tdragLeftDrop: this._onDragLeftDrop,\r\n\t\tdragLeftCancel: this._onDragLeftCancel\r\n\t};\r\n\r\n\t// Define options\r\n\tconst options = {\r\n\t\ttarget: this.controlIcon ? \"controlIcon\" : null\r\n\t};\r\n\r\n\t// Create the interaction manager\r\n\tthis.mouseInteractionManager = new MouseInteractionManager(this, canvas.stage, permissions, callbacks, options).activate();\r\n}\r\n\r\nfunction handleTokenItemConfig(e?, controlledToken?: Token) {\r\n\tconsole.log(`pick-up-stix | handleTokenItemConfig called with args`);\r\n\tclearTimeout(clickTimeout);\r\n\tconst clickedToken: Token = this;\r\n\r\n\ttry {\r\n\t\tconst maxDist = Math.hypot(canvas.grid.size, canvas.grid.size);\r\n\t\tif (!controlledToken && game.user.isGM) {\r\n\t\t\tcontrolledToken = canvas.tokens.controlled?.filter((t: Token) => dist(t, clickedToken) < maxDist && t.getFlag('pick-up-stix', 'pick-up-stix') === undefined)[0]\r\n\t\t}\r\n\t}\r\n\tcatch (e) {\r\n\t\tcontrolledToken = null;\r\n\t}\r\n\r\n\tconst f = new ItemConfigApplication(clickedToken, controlledToken).render(true);\r\n}\r\n\r\nasync function toggleItemLocked(e): Promise<any> {\r\n\tconsole.log(`pick-up-stix | toggleItemLocked`);\r\n\r\n\tconst clickedToken: Token = this;\r\n\tconst flags: PickUpStixFlags = clickedToken.getFlag('pick-up-stix', 'pick-up-stix');\r\n\tawait clickedToken.setFlag('pick-up-stix', 'pick-up-stix.isLocked', !flags.isLocked);\r\n}\r\n\r\nlet clickTimeout;\r\nasync function handleTokenItemClicked(e): Promise<void> {\r\n\tconsole.log(`pick-up-stix | handleTokenItemClicked | ${this.id}`);\r\n\r\n\tconst clickedToken: Token = this;\r\n\r\n\t// if the token is hidden just do a normal click\r\n\tif (e.currentTarget.data.hidden) {\r\n\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | token is hidden, handle normal click`);\r\n\t\t(clickedToken as any)._onClickLeft(e);\r\n\t\treturn;\r\n\t}\r\n\r\n\t// if the item isn't visible can't pick it up\r\n\tif (!clickedToken.isVisible) {\r\n\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | item is not visible to user`);\r\n\t\treturn;\r\n\t}\r\n\r\n\t// get the tokens that the user controls\r\n  let controlledTokens: Token[] = canvas.tokens.controlled;\r\n\r\n\t// gm special stuff\r\n\tif (game.user.isGM) {\r\n\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | user is GM`);\r\n\r\n\t\tif (!controlledTokens.length) {\r\n\t\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | no controlled tokens, handle normal click`);\r\n\t\t\t(clickedToken as any)._onClickLeft(e);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// if only controlling the item itself, handle a normal click\r\n\t\tif (controlledTokens.every(t => clickedToken === t)) {\r\n\t\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | only controlling the item, handle normal click`);\r\n\t\t\t(clickedToken as any)._onClickLeft(e);\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n\r\n\t// get only the tokens that are within the right distance\r\n\tconst maxDist = Math.hypot(canvas.grid.size, canvas.grid.size);\r\n\tcontrolledTokens = controlledTokens.filter(t => dist(t, clickedToken) < (maxDist + 20) && t.getFlag('pick-up-stix', 'pick-up-stix') === undefined);\r\n\r\n\t// if there are no controlled tokens within reach, show an error\r\n\tif (!controlledTokens.length) {\r\n\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | item is out of reach`);\r\n\t\tui.notifications.error('You are too far away to interact with that');\r\n\t\treturn;\r\n\t}\r\n\r\n\t// get the flags on the clicked token\r\n\tconst flags: PickUpStixFlags = duplicate(clickedToken.getFlag('pick-up-stix', 'pick-up-stix'));\r\n\r\n\t// if it's locked then it can't be opened\r\n\tif (flags.isLocked) {\r\n\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | item is locked`);\r\n\t\tvar audio = new Audio('sounds/lock.wav');\r\n\t\taudio.play();\r\n\t\treturn;\r\n\t}\r\n\r\n\tclickTimeout = setTimeout(async () => {\r\n\t\tconst controlledToken: Token =\r\n\t\t\tcontrolledTokens.length === 1 ?\r\n\t\t\tcontrolledTokens[0] :\r\n\t\t\tawait new Promise(resolve => {\r\n\t\t\t\tconst d = new ChooseTokenApplication(controlledTokens).render(true);\r\n\t\t\t\tHooks.once('closeChooseTokenApplication', () => {\r\n\t\t\t\t\tresolve(d.getData().selectedToken);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\tif (!controlledToken) {\r\n\t\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | No token selected from dialog`);\r\n\t\t\tui.notifications.error('You must control at least one token.');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif(flags.itemType === ItemType.CONTAINER) {\r\n\t\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | item is a container`);\r\n\r\n\t\t\t// if it's a container and it's open and can't be closed then don't do anything\r\n\t\t\tif (flags.isOpen && !(flags.canClose ?? true)) {\r\n\t\t\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | container is open and can't be closed`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tflags.isOpen = !flags.isOpen;\r\n\r\n\t\t\t// if there are any container updates then update the container\r\n\t\t\tawait new Promise(resolve => {\r\n\t\t\t\tsetTimeout(async () => {\r\n\t\t\t\t\tawait updateToken(clickedToken, {\r\n\t\t\t\t\t\timg: flags.isOpen ? flags.imageContainerOpenPath : flags.imageContainerClosedPath,\r\n\t\t\t\t\t\tflags: {\r\n\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t'pick-up-stix': {\r\n\t\t\t\t\t\t\t\t\t...flags\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}, 200);\r\n\t\t\t});\r\n\r\n\t\t\tif (!flags.isOpen) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\thandleTokenItemConfig.bind(this)(null, controlledToken);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconsole.log(`pick-up-stix | handleTokenItemClicked | token is an ItemType.ITEM`);\r\n\r\n\t\t// if it's just a single item, delete the map token and create an new item on the player\r\n\t\tawait deleteToken(clickedToken);\r\n\t\tawait createOwnedEntity(controlledToken.actor, {\r\n\t\t\t...flags.initialState.itemData,\r\n\t\t\tflags: {\r\n\t\t\t\t...clickedToken.data.flags\r\n\t\t\t}\r\n\t\t});\r\n\t\titemCollected(controlledToken, { ...flags.initialState.itemData });\r\n\t}, 250);\r\n\r\n\tthis.mouseInteractionManager?._deactivateDragEvents();\r\n}\r\n\r\nasync function deleteToken(token: Token): Promise<void> {\r\n\tconsole.log(`pick-up-stix | deleteToken with args:`);\r\n\tconsole.log(token);\r\n\r\n\tif (game.user.isGM) {\r\n\t\tawait canvas.scene.deleteEmbeddedEntity('Token', token.id);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst msg: PickUpStixSocketMessage = {\r\n\t\tsender: game.user.id,\r\n\t\ttype: SocketMessageType.deleteToken,\r\n\t\tdata: token.id\r\n\t}\r\n\tsocket.emit('module.pick-up-stix', msg);\r\n}\r\n\r\nexport async function updateToken(token: Token, updates): Promise<void> {\r\n\tconsole.log(`pick-up-stix | updateToken with args:`);\r\n\tconsole.log([token, updates]);\r\n\r\n\tif (game.user.isGM) {\r\n\t\tawait token.update(updates);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst msg: PickUpStixSocketMessage = {\r\n\t\tsender: game.user.id,\r\n\t\ttype: SocketMessageType.updateToken,\r\n\t\tdata: {\r\n\t\t\ttokenId: token.id,\r\n\t\t\tupdates\r\n\t\t}\r\n\t};\r\n\r\n\tsocket.emit('module.pick-up-stix', msg, () => {\r\n\t\tconsole.log(`pick-up-stix | updateToken | socket message handled`);\r\n\t});\r\n}\r\n\r\nexport async function updateActor(actor, updates): Promise<void> {\r\n\tif (game.user.isGM) {\r\n\t\tawait actor.update(updates);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst msg: PickUpStixSocketMessage = {\r\n\t\tsender: game.user.id,\r\n\t\ttype: SocketMessageType.updateActor,\r\n\t\tdata: {\r\n\t\t\tactorId: actor.id,\r\n\t\t\tupdates\r\n\t\t}\r\n\t};\r\n\r\n\tsocket.emit('module.pick-up-stix', msg);\r\n}\r\n\r\nexport async function createOwnedEntity(actor: Actor, items: any[]) {\r\n\tif (game.user.isGM) {\r\n\t\tawait actor.createOwnedItem(items);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst msg: PickUpStixSocketMessage = {\r\n\t\tsender: game.user.id,\r\n\t\ttype: SocketMessageType.createOwnedEntity,\r\n\t\tdata: {\r\n\t\t\tactorId: actor.id,\r\n\t\t\titems\r\n\t\t}\r\n\t};\r\n\r\n\tsocket.emit('module.pick-up-stix', msg, () => {\r\n\t\tconsole.log(`pick-up-stix | createOwnedEntity | socket message handled`);\r\n\t});\r\n}\r\n\r\nasync function createItemToken(data: any): Promise<string> {\r\n\tconsole.log(`pick-up-stix | createItemToken | called with args:`);\r\n\tconsole.log(data);\r\n\tif (game.user.isGM) {\r\n\t\tconsole.log(`pick-up-stix | createItemToken | current user is GM, creating token`);\r\n\t\tconst t = await Token.create({\r\n\t\t\t...data\r\n\t\t});\r\n\t\treturn t.id;\r\n\t}\r\n\r\n\tconsole.log(`pick-up-stix | createItemToken | current user is not GM, send socket message`);\r\n\tconst msg: PickUpStixSocketMessage = {\r\n\t\tsender: game.user.id,\r\n\t\ttype: SocketMessageType.createItemToken,\r\n\t\tdata\r\n\t}\r\n\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tconst timeout = setTimeout(() => {\r\n\t\t\treject('Token never created');\r\n\t\t}, 2000);\r\n\r\n\t\tsocket.emit('module.pick-up-stix', msg, () => {\r\n\t\t\tconsole.log(`pick-up-stix | createItemToken | socket message handled`);\r\n\r\n\t\t\tHooks.once('createToken', (scene, data) => {\r\n\t\t\t\t// TODO: could possibly add a custom custom authentication ID to the data we emit, then we can\r\n\t\t\t\t// check that ID against this created token ID and make sure we are getting the right one. Seems\r\n\t\t\t\t// like it could be rare, but there could be a race condition with other tokens being created\r\n\t\t\t\t// near the same time we are creating this token. Maybe through other modules doing it.\r\n\t\t\t\tconsole.log(`pick-up-stix | createItemToken | createToken hook | Token '${data.id}' created`);\r\n\t\t\t\tclearTimeout(timeout);\r\n\t\t\t\tresolve(data._id);\r\n\t\t\t});\r\n\t\t});\r\n\t});\r\n}\r\n\r\nexport async function drawLockIcon(p: PlaceableObject): Promise<any> {\r\n\tconsole.log(`pick-up-stix | drawLockIcon | called with args:`);\r\n\tconsole.log(p);\r\n\r\n\tconst lock = p.getChildByName('pick-up-stix-lock');\r\n\tif (lock) {\r\n\t\tconsole.log(`pick-up-stix | drawLockIcon | found previous lock icon, removing it`)\r\n\t\tp.removeChild(lock);\r\n\t\tlock.destroy();\r\n\t}\r\n\r\n\tconst tex = await loadTexture('icons/svg/padlock.svg');\r\n\tconst icon = p.addChild(new PIXI.Sprite(tex));\r\n\ticon.name = 'pick-up-stix-lock';\r\n\ticon.width = icon.height = 40;\r\n\ticon.alpha = .5;\r\n\ticon.position.set(p.width * .5 - icon.width * .5, p.height * .5 - icon.height * .5);\r\n}\r\n\r\nexport function itemCollected(actorToken, item) {\r\n\tChatMessage.create({\r\n\t\tcontent: `\r\n\t\t\t<p>Picked up ${item.name}</p>\r\n\t\t\t<img src=\"${item.img}\" style=\"width: 40px;\" />\r\n\t\t`,\r\n\t\tspeaker: {\r\n\t\t\talias: actorToken.actor.name,\r\n\t\t\tscene: (game.scenes as any).active.id,\r\n\t\t\tactor: actorToken.actor.id,\r\n\t\t\ttoken: actorToken.id\r\n\t\t}\r\n\t});\r\n}\r\n\r\nexport function currencyCollected(actorToken, currency) {\r\n\tconsole.log(`pick-up-stix | currencyCollected | called with args:`);\r\n\tconsole.log([actorToken, currency]);\r\n\tlet chatContent = '';\r\n\tObject.entries(currency).forEach(([k, v]) => {\r\n\t\tchatContent += `<span class=\"pick-up-stix-chat-currency ${k}\"></span><span>(${k}) ${v}</span><br />`;\r\n\t});\r\n\tlet content = `<p>Picked up:</p>${chatContent}`;\r\n\tChatMessage.create({\r\n\t\tcontent,\r\n\t\tspeaker: {\r\n\t\t\talias: actorToken.actor.name,\r\n\t\t\tscene: (game.scenes as any).active.id,\r\n\t\t\tactor: actorToken.actor.id,\r\n\t\t\ttoken: actorToken.id\r\n\t\t}\r\n\t});\r\n}"]}